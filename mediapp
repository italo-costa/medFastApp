#!/usr/bin/env bash
# üè• MediApp - Gerenciador de Sistema v3.0.0
# Interface unificada para todos os scripts e opera√ß√µes

GREEN='\033[0;32m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BACKEND_DIR="$SCRIPT_DIR/apps/backend"
SERVICES_CONFIG="/tmp/mediapp-services.json"

# Fun√ß√£o de ajuda
show_help() {
    echo -e "${PURPLE}"
    cat << 'EOF'
üè• ================================================
   MediApp v3.0.0 - Gerenciador de Sistema
üè• ================================================
EOF
    echo -e "${NC}"
    
    echo -e "${CYAN}COMANDOS DISPON√çVEIS:${NC}"
    echo ""
    echo -e "${GREEN}üìã OPERA√á√ïES PRINCIPAIS:${NC}"
    echo "  start          Iniciar sistema completo (recomendado)"
    echo "  stop           Parar todos os servi√ßos"
    echo "  restart        Reiniciar sistema completo"
    echo "  status         Verificar status de todos os servi√ßos"
    echo ""
    echo -e "${GREEN}üîß OPERA√á√ïES DE MANUTEN√á√ÉO:${NC}"
    echo "  cleanup        Limpar processos e arquivos tempor√°rios"
    echo "  ports          Gerenciar e verificar portas"
    echo "  logs           Visualizar logs do sistema"
    echo "  health         Verificar sa√∫de do sistema"
    echo ""
    echo -e "${GREEN}üêò OPERA√á√ïES DE BANCO:${NC}"
    echo "  db-setup       Configurar apenas PostgreSQL"
    echo "  db-reset       Resetar banco de dados"
    echo "  db-migrate     Aplicar migra√ß√µes"
    echo "  db-status      Status do banco de dados"
    echo ""
    echo -e "${GREEN}üöÄ MODOS DE DESENVOLVIMENTO:${NC}"
    echo "  dev            Modo desenvolvimento (com hot-reload)"
    echo "  minimal        Iniciar apenas servidor m√≠nimo"
    echo "  demo           Iniciar servidor demo"
    echo "  test           Iniciar ambiente de teste"
    echo ""
    echo -e "${GREEN}üìä INFORMA√á√ïES:${NC}"
    echo "  info           Informa√ß√µes do sistema"
    echo "  config         Mostrar configura√ß√£o atual"
    echo "  report         Gerar relat√≥rio completo"
    echo ""
    echo -e "${YELLOW}EXEMPLOS DE USO:${NC}"
    echo "  $0 start                 # Iniciar sistema completo"
    echo "  $0 ports --check         # Verificar conflitos de porta"  
    echo "  $0 logs --follow         # Acompanhar logs em tempo real"
    echo "  $0 dev --port 3001       # Desenvolvimento na porta 3001"
    echo ""
}

# Fun√ß√£o para verificar status
check_status() {
    echo -e "${BLUE}üìä Status do Sistema MediApp${NC}"
    echo "================================"
    
    # PostgreSQL
    if docker ps | grep -q "mediapp-db"; then
        local db_port=$(docker port mediapp-db 5432/tcp 2>/dev/null | cut -d: -f2 || echo "N/A")
        echo -e "${GREEN}‚úÖ PostgreSQL: RODANDO${NC} (porta: $db_port)"
    else
        echo -e "${RED}‚ùå PostgreSQL: PARADO${NC}"
    fi
    
    # Servidor Node.js
    local main_pid=""
    if [ -f "/tmp/mediapp-main.pid" ]; then
        main_pid=$(cat "/tmp/mediapp-main.pid" 2>/dev/null)
    fi
    
    if [ -n "$main_pid" ] && kill -0 "$main_pid" 2>/dev/null; then
        local port="N/A"
        if [ -f "$SERVICES_CONFIG" ]; then
            port=$(grep -o '"main": [0-9]*' "$SERVICES_CONFIG" 2>/dev/null | cut -d' ' -f2 || echo "N/A")
        fi
        echo -e "${GREEN}‚úÖ Servidor Principal: RODANDO${NC} (PID: $main_pid, porta: $port)"
    else
        echo -e "${RED}‚ùå Servidor Principal: PARADO${NC}"
    fi
    
    # Arquivos de configura√ß√£o
    echo ""
    echo -e "${BLUE}üìÅ Arquivos de Sistema:${NC}"
    
    if [ -f "$SERVICES_CONFIG" ]; then
        echo -e "${GREEN}‚úÖ Configura√ß√£o: PRESENTE${NC} ($SERVICES_CONFIG)"
    else
        echo -e "${YELLOW}‚ö†Ô∏è Configura√ß√£o: AUSENTE${NC}"
    fi
    
    if [ -d "/tmp/mediapp-logs" ]; then
        local log_count=$(find /tmp/mediapp-logs -name "*.log" 2>/dev/null | wc -l)
        echo -e "${GREEN}‚úÖ Logs: $log_count arquivos${NC} (/tmp/mediapp-logs/)"
    else
        echo -e "${YELLOW}‚ö†Ô∏è Logs: DIRET√ìRIO AUSENTE${NC}"
    fi
}

# Fun√ß√£o para limpar sistema
cleanup_system() {
    echo -e "${YELLOW}üßπ Limpando sistema...${NC}"
    
    # Parar processos Node.js
    echo "Parando processos Node.js..."
    pkill -f "node.*app" 2>/dev/null || true
    pkill -f "node.*server" 2>/dev/null || true
    
    # Parar containers Docker
    echo "Parando containers Docker..."
    docker stop mediapp-db 2>/dev/null || true
    docker rm mediapp-db 2>/dev/null || true
    
    # Remover arquivos tempor√°rios
    echo "Removendo arquivos tempor√°rios..."
    rm -f /tmp/mediapp-*.pid 2>/dev/null || true
    rm -f /tmp/mediapp-*.log 2>/dev/null || true
    
    echo -e "${GREEN}‚úÖ Limpeza conclu√≠da${NC}"
}

# Fun√ß√£o para gerenciar portas
manage_ports() {
    local action=${1:-"check"}
    
    case $action in
        "check"|"--check")
            echo -e "${BLUE}üîç Verificando conflitos de porta...${NC}"
            
            # Portas principais do MediApp
            local ports=(3001 3002 3003 3004 5432 5433 5434)
            
            for port in "${ports[@]}"; do
                if netstat -tlnp 2>/dev/null | grep -q ":${port}.*LISTEN"; then
                    local pid=$(lsof -ti:$port 2>/dev/null || echo "N/A")
                    echo -e "${RED}‚ùå Porta $port: EM USO${NC} (PID: $pid)"
                else
                    echo -e "${GREEN}‚úÖ Porta $port: LIVRE${NC}"
                fi
            done
            ;;
        "free"|"--free")
            local target_port=$2
            if [ -z "$target_port" ]; then
                echo -e "${RED}Erro: Especifique a porta para liberar${NC}"
                echo "Uso: $0 ports free <porta>"
                return 1
            fi
            
            echo -e "${YELLOW}üîÑ Liberando porta $target_port...${NC}"
            local pids=$(lsof -ti:$target_port 2>/dev/null || echo "")
            
            if [ -n "$pids" ]; then
                echo "Finalizando processos: $pids"
                echo "$pids" | xargs -r kill -9 2>/dev/null || true
                sleep 1
                echo -e "${GREEN}‚úÖ Porta $target_port liberada${NC}"
            else
                echo -e "${YELLOW}‚ö†Ô∏è Nenhum processo encontrado na porta $target_port${NC}"
            fi
            ;;
        *)
            echo -e "${YELLOW}A√ß√µes dispon√≠veis para portas:${NC}"
            echo "  check    Verificar conflitos"
            echo "  free     Liberar porta espec√≠fica"
            ;;
    esac
}

# Fun√ß√£o para visualizar logs
show_logs() {
    local action=${1:-"latest"}
    local log_dir="/tmp/mediapp-logs"
    
    if [ ! -d "$log_dir" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è Diret√≥rio de logs n√£o encontrado: $log_dir${NC}"
        return 1
    fi
    
    case $action in
        "latest"|"--latest")
            echo -e "${BLUE}üìã √öltimos logs do sistema:${NC}"
            echo "================================"
            
            for log_file in "$log_dir"/*.log; do
                if [ -f "$log_file" ]; then
                    echo -e "\n${CYAN}$(basename "$log_file"):${NC}"
                    tail -5 "$log_file" | sed 's/^/  /'
                fi
            done
            ;;
        "follow"|"--follow")
            echo -e "${BLUE}üìã Acompanhando logs em tempo real (Ctrl+C para sair):${NC}"
            if [ -f "$log_dir/app.log" ]; then
                tail -f "$log_dir/app.log"
            else
                echo -e "${YELLOW}‚ö†Ô∏è Arquivo app.log n√£o encontrado${NC}"
            fi
            ;;
        "clear"|"--clear")
            echo -e "${YELLOW}üóëÔ∏è Limpando logs...${NC}"
            rm -f "$log_dir"/*.log 2>/dev/null || true
            echo -e "${GREEN}‚úÖ Logs limpos${NC}"
            ;;
        *)
            echo -e "${YELLOW}A√ß√µes dispon√≠veis para logs:${NC}"
            echo "  latest   Mostrar √∫ltimos logs"
            echo "  follow   Acompanhar em tempo real"
            echo "  clear    Limpar todos os logs"
            ;;
    esac
}

# Fun√ß√£o principal
main() {
    local command=${1:-"help"}
    shift || true
    
    case $command in
        "start")
            echo -e "${CYAN}üöÄ Iniciando MediApp v3.0.0...${NC}"
            chmod +x "$SCRIPT_DIR/start-unified.sh"
            "$SCRIPT_DIR/start-unified.sh" "$@"
            ;;
        "stop")
            echo -e "${YELLOW}üõë Parando sistema...${NC}"
            cleanup_system
            ;;
        "restart")
            echo -e "${CYAN}üîÑ Reiniciando sistema...${NC}"
            cleanup_system
            sleep 2
            chmod +x "$SCRIPT_DIR/start-unified.sh"
            "$SCRIPT_DIR/start-unified.sh" "$@"
            ;;
        "status")
            check_status
            ;;
        "cleanup")
            cleanup_system
            ;;
        "ports")
            manage_ports "$@"
            ;;
        "logs")
            show_logs "$@"
            ;;
        "health")
            echo -e "${BLUE}üè• Verifica√ß√£o de sa√∫de...${NC}"
            check_status
            
            # Teste de conectividade
            if [ -f "$SERVICES_CONFIG" ]; then
                local port=$(grep -o '"main": [0-9]*' "$SERVICES_CONFIG" 2>/dev/null | cut -d' ' -f2)
                if [ -n "$port" ]; then
                    echo ""
                    echo -e "${BLUE}üåê Teste de conectividade:${NC}"
                    if timeout 3 bash -c "</dev/tcp/localhost/$port" 2>/dev/null; then
                        echo -e "${GREEN}‚úÖ Servidor acess√≠vel na porta $port${NC}"
                    else
                        echo -e "${RED}‚ùå Servidor n√£o acess√≠vel na porta $port${NC}"
                    fi
                fi
            fi
            ;;
        "info")
            echo -e "${PURPLE}‚ÑπÔ∏è Informa√ß√µes do Sistema MediApp v3.0.0${NC}"
            echo "=========================================="
            echo "Diret√≥rio: $SCRIPT_DIR"
            echo "Backend: $BACKEND_DIR"
            echo "Configura√ß√£o: $SERVICES_CONFIG"
            echo "Node.js: $(node -v 2>/dev/null || echo 'N√£o encontrado')"
            echo "Docker: $(docker --version 2>/dev/null | cut -d' ' -f3 | cut -d',' -f1 || echo 'N√£o encontrado')"
            ;;
        "config")
            if [ -f "$SERVICES_CONFIG" ]; then
                echo -e "${BLUE}üìã Configura√ß√£o Atual:${NC}"
                cat "$SERVICES_CONFIG" | python3 -m json.tool 2>/dev/null || cat "$SERVICES_CONFIG"
            else
                echo -e "${YELLOW}‚ö†Ô∏è Arquivo de configura√ß√£o n√£o encontrado: $SERVICES_CONFIG${NC}"
            fi
            ;;
        "help"|"-h"|"--help"|"")
            show_help
            ;;
        *)
            echo -e "${RED}‚ùå Comando n√£o reconhecido: $command${NC}"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

# Executar fun√ß√£o principal
main "$@"