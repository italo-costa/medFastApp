# üê≥ MediApp Backend - Multi-stage Docker Build

FROM node:18-alpine AS builder

# Configurar diret√≥rio de trabalho
WORKDIR /app

# Instalar depend√™ncias do sistema
RUN apk add --no-cache \
    python3 \
    make \
    g++ \
    postgresql-client

# Copiar arquivos de depend√™ncias
COPY package*.json ./
COPY prisma ./prisma/

# Instalar depend√™ncias
RUN npm install && npm cache clean --force

# Gerar Prisma Client
RUN npx prisma generate

# Est√°gio de produ√ß√£o
FROM node:18-alpine AS production

# Criar usu√°rio n√£o-root
RUN addgroup -g 1001 -S nodejs
RUN adduser -S mediapp -u 1001

# Configurar diret√≥rio
WORKDIR /app

# Instalar cliente PostgreSQL
RUN apk add --no-cache postgresql-client

# Copiar node_modules do builder
COPY --from=builder --chown=mediapp:nodejs /app/node_modules ./node_modules
COPY --from=builder --chown=mediapp:nodejs /app/package*.json ./

# Copiar c√≥digo da aplica√ß√£o
COPY --chown=mediapp:nodejs ./src ./src
COPY --chown=mediapp:nodejs ./prisma ./prisma
COPY --chown=mediapp:nodejs ./public ./public

# Criar diret√≥rios necess√°rios com permiss√µes corretas
RUN mkdir -p uploads logs && chown -R mediapp:nodejs uploads logs

# Configurar usu√°rio
USER mediapp

# Expor porta
EXPOSE 3002

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD node -e "const http=require('http');http.get('http://localhost:3002/health',(r)=>{process.exit(r.statusCode===200?0:1)})"

# Comando de inicializa√ß√£o
CMD ["node", "src/app.js"]