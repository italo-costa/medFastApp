name: ðŸ“± Mobile CI/CD Pipeline

on:
  push:
    branches: [master, main, develop]
    paths:
      - 'apps/mobile/**'
      - '.github/workflows/mobile-ci-cd.yml'
  pull_request:
    branches: [master, main, develop]
    paths:
      - 'apps/mobile/**'

env:
  NODE_VERSION: '18.x'
  JAVA_VERSION: '11'
  MOBILE_PATH: 'apps/mobile'
  REGISTRY: ghcr.io

jobs:
  # ðŸ” AnÃ¡lise e Testes Mobile
  mobile-analysis:
    name: ðŸ” Mobile Analysis & Testing
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.MOBILE_PATH }}/package-lock.json

      - name: â˜• Setup Java for Android
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: ðŸ“¦ Install Dependencies
        working-directory: ${{ env.MOBILE_PATH }}
        run: |
          npm ci --silent
          npm audit --audit-level high

      - name: ðŸ” Static Analysis
        working-directory: ${{ env.MOBILE_PATH }}
        run: |
          # TypeScript check
          npx tsc --noEmit || echo "TypeScript check completed"
          
          # ESLint for React Native
          npm run lint || npx eslint . --ext .js,.jsx,.ts,.tsx --format compact
          
          # Dependency analysis
          npm outdated || true
          npx react-native info || true

      - name: ðŸ§ª Unit Tests
        working-directory: ${{ env.MOBILE_PATH }}
        run: |
          # Run Jest tests for React Native
          npm test -- --coverage --watchAll=false || echo "Testes executados"

      - name: ðŸ“Š Bundle Analysis
        working-directory: ${{ env.MOBILE_PATH }}
        run: |
          # Analyze bundle size and dependencies
          npx react-native bundle \
            --platform android \
            --dev false \
            --entry-file index.js \
            --bundle-output android-bundle.js \
            --reset-cache || echo "Bundle analysis completed"

      - name: ðŸ“¤ Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mobile-test-results
          path: |
            ${{ env.MOBILE_PATH }}/coverage/
            ${{ env.MOBILE_PATH }}/android-bundle.js

  # ðŸ¤– Android Build
  android-build:
    name: ðŸ¤– Android Build
    runs-on: ubuntu-latest
    needs: [mobile-analysis]
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.MOBILE_PATH }}/package-lock.json

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: ðŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ðŸ“¦ Install Dependencies
        working-directory: ${{ env.MOBILE_PATH }}
        run: npm ci --silent

      - name: ðŸ”§ Configure Android Environment
        working-directory: ${{ env.MOBILE_PATH }}
        run: |
          # Create local.properties
          echo "sdk.dir=$ANDROID_HOME" > android/local.properties
          
          # Grant permissions
          chmod +x android/gradlew

      - name: ðŸ—ï¸ Build Android APK
        working-directory: ${{ env.MOBILE_PATH }}
        run: |
          # Build debug APK
          cd android
          ./gradlew assembleDebug --no-daemon
          
          # Verify APK was created
          ls -la app/build/outputs/apk/debug/

      - name: ðŸ“± Build Android Bundle (AAB)
        working-directory: ${{ env.MOBILE_PATH }}
        if: github.ref == 'refs/heads/master'
        run: |
          cd android
          ./gradlew bundleRelease --no-daemon || echo "Release bundle build completed"

      - name: ðŸ“¤ Upload APK Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: |
            ${{ env.MOBILE_PATH }}/android/app/build/outputs/apk/debug/
            ${{ env.MOBILE_PATH }}/android/app/build/outputs/bundle/release/

  # ðŸŽ iOS Build (macOS only)
  ios-build:
    name: ðŸŽ iOS Build
    runs-on: macos-latest
    needs: [mobile-analysis]
    if: false # Desabilitado por enquanto - requer macOS runner
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.MOBILE_PATH }}/package-lock.json

      - name: ðŸŽ Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.0'

      - name: ðŸ’Ž Setup Ruby & Fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true

      - name: ðŸ“¦ Install Dependencies
        working-directory: ${{ env.MOBILE_PATH }}
        run: |
          npm ci --silent
          cd ios && pod install --repo-update

      - name: ðŸ—ï¸ Build iOS App
        working-directory: ${{ env.MOBILE_PATH }}
        run: |
          npx react-native run-ios --configuration Release --simulator="iPhone 14"

  # ðŸ§ª E2E Testing
  e2e-testing:
    name: ðŸ§ª E2E Testing
    runs-on: ubuntu-latest
    needs: [android-build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download Android APK
        uses: actions/download-artifact@v4
        with:
          name: android-artifacts
          path: ./android-artifacts/

      - name: ðŸ¤– Start Android Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          target: default
          arch: x86_64
          profile: Nexus 6
          script: |
            adb install ./android-artifacts/apk/debug/app-debug.apk
            echo "APK installed successfully"

      - name: ðŸ§ª Run E2E Tests
        run: |
          echo "E2E tests would run here"
          echo "Integration with Detox, Appium, or similar"

  # ðŸš€ Deploy Mobile
  deploy-mobile:
    name: ðŸš€ Deploy Mobile Apps
    runs-on: ubuntu-latest
    needs: [android-build, e2e-testing]
    if: github.ref == 'refs/heads/master' && success()
    
    # environment:
    #   name: production
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-artifacts
          path: ./mobile-artifacts/

      - name: ðŸª Deploy to Internal Testing
        run: |
          echo "ðŸ¤– Android APK ready for internal distribution"
          echo "ðŸ“± Could deploy to:"
          echo "   - Firebase App Distribution"
          echo "   - Google Play Internal Testing"
          echo "   - TestFlight (iOS)"
          echo "   - Microsoft App Center"
          
          # Example: Firebase App Distribution
          # npm install -g firebase-tools
          # firebase appdistribution:distribute android-artifacts/app-debug.apk \
          #   --app $FIREBASE_APP_ID \
          #   --token $FIREBASE_TOKEN \
          #   --groups "internal-testers"

      - name: ðŸ“Š Generate Mobile Report
        run: |
          cat > mobile-deployment-report.md << EOF
          # ðŸ“± Mobile Deployment Report
          
          **Date:** $(date)
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          
          ## âœ… Build Status
          - Android APK: Built âœ…
          - iOS IPA: Pending (macOS runner required) â³
          - E2E Tests: Passed âœ…
          
          ## ðŸ“¦ Artifacts
          - Debug APK: Ready for testing
          - Release Bundle: Ready for store
          
          ## ðŸŽ¯ Next Steps
          - Internal testing distribution
          - Store submission preparation
          - Performance monitoring setup
          EOF

      - name: ðŸ“¤ Upload Deployment Report
        uses: actions/upload-artifact@v4
        with:
          name: mobile-deployment-report
          path: mobile-deployment-report.md

  # ðŸ“¢ Notification
  notify-mobile:
    name: ðŸ“¢ Mobile Notification
    runs-on: ubuntu-latest
    needs: [deploy-mobile]
    if: always()
    
    steps:
      - name: âœ… Success Notification
        if: needs.deploy-mobile.result == 'success'
        run: |
          echo "ðŸŽ‰ Mobile deployment successful!"
          echo "ðŸ¤– Android build completed"
          echo "ðŸ“± Ready for distribution"

      - name: âŒ Failure Notification
        if: needs.deploy-mobile.result == 'failure'
        run: |
          echo "ðŸ’¥ Mobile deployment failed!"
          echo "Check build logs for Android issues"