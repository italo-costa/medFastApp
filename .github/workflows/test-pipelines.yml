name: ğŸ§ª Test Individual Pipelines

on:
  workflow_dispatch:
    inputs:
      pipeline:
        description: 'Which pipeline to test'
        required: true
        type: choice
        options:
          - backend
          - frontend
          - mobile
          - database
          - all

env:
  NODE_VERSION: '18.x'

jobs:
  test-backend:
    name: ğŸ§ª Test Backend Pipeline
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.pipeline == 'backend' || github.event.inputs.pipeline == 'all' }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ§ª Test Backend Structure
        working-directory: apps/backend
        run: |
          echo "ğŸ” Testing backend structure..."
          
          # Verify package.json exists
          if [ -f "package.json" ]; then
            echo "âœ… package.json found"
          else
            echo "âŒ package.json not found"
            exit 1
          fi
          
          # Verify key dependencies
          deps=("express" "prisma" "@prisma/client")
          for dep in "${deps[@]}"; do
            if grep -q "\"$dep\"" package.json; then
              echo "âœ… Dependency $dep found"
            else
              echo "âŒ Dependency $dep not found"
            fi
          done
          
          # Install dependencies
          npm ci --silent
          echo "âœ… Dependencies installed"
          
          # Verify Prisma schema
          if [ -f "prisma/schema.prisma" ]; then
            echo "âœ… Prisma schema found"
            npx prisma validate
            echo "âœ… Prisma schema valid"
          fi

  test-frontend:
    name: ğŸŒ Test Frontend Pipeline
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.pipeline == 'frontend' || github.event.inputs.pipeline == 'all' }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ§ª Test Frontend Structure
        working-directory: apps/backend/public
        run: |
          echo "ğŸ” Testing frontend structure..."
          
          # Verify HTML files
          html_files=("index.html" "agenda-medica.html" "gestao-medicos.html" "gestao-pacientes.html")
          for file in "${html_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file found"
              
              # Basic HTML validation
              if grep -q "<!DOCTYPE html>" "$file"; then
                echo "âœ… $file has valid DOCTYPE"
              else
                echo "âš ï¸ $file missing DOCTYPE"
              fi
            else
              echo "âš ï¸ $file not found"
            fi
          done
          
          # Verify CSS/JS assets
          css_count=$(find . -name "*.css" | wc -l)
          js_count=$(find . -name "*.js" | wc -l)
          
          echo "âœ… Found $css_count CSS files"
          echo "âœ… Found $js_count JS files"

  test-mobile:
    name: ğŸ“± Test Mobile Pipeline
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.pipeline == 'mobile' || github.event.inputs.pipeline == 'all' }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ§ª Test Mobile Structure
        working-directory: apps/mobile
        run: |
          echo "ğŸ” Testing mobile structure..."
          
          # Verify package.json exists
          if [ -f "package.json" ]; then
            echo "âœ… package.json found"
          else
            echo "âŒ package.json not found"
            exit 1
          fi
          
          # Verify React Native dependencies
          rn_deps=("react" "react-native" "@reduxjs/toolkit")
          for dep in "${rn_deps[@]}"; do
            if grep -q "\"$dep\"" package.json; then
              echo "âœ… RN Dependency $dep found"
            else
              echo "âš ï¸ RN Dependency $dep not found"
            fi
          done
          
          # Verify Android configuration
          if [ -d "android" ]; then
            echo "âœ… Android configuration found"
          else
            echo "âš ï¸ Android configuration not found"
          fi
          
          # Verify src structure
          if [ -d "src" ]; then
            echo "âœ… Source directory found"
            
            # Count React Native components
            components=$(find src -name "*.tsx" -o -name "*.jsx" | wc -l)
            echo "âœ… Found $components React Native components"
          fi

  test-database:
    name: ğŸ—„ï¸ Test Database Pipeline
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.pipeline == 'database' || github.event.inputs.pipeline == 'all' }}
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ§ª Test Database Structure
        working-directory: apps/backend
        env:
          DATABASE_URL: "postgresql://test_user:test_pass@localhost:5432/test_db"
        run: |
          echo "ğŸ” Testing database structure..."
          
          # Install Prisma
          npm install prisma @prisma/client --silent
          
          # Verify schema
          if [ -f "prisma/schema.prisma" ]; then
            echo "âœ… Prisma schema found"
            
            # Validate schema
            npx prisma validate
            echo "âœ… Schema validation passed"
            
            # Generate client
            npx prisma generate
            echo "âœ… Prisma client generated"
            
            # Test database connection
            npx prisma db push --accept-data-loss
            echo "âœ… Database schema applied"
            
            # Verify models
            models=("Usuario" "Medico" "Paciente" "Agendamento")
            for model in "${models[@]}"; do
              if grep -q "model $model" prisma/schema.prisma; then
                echo "âœ… Model $model found"
              else
                echo "âš ï¸ Model $model not found"
              fi
            done
          else
            echo "âŒ Prisma schema not found"
            exit 1
          fi

  report:
    name: ğŸ“Š Test Report
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend, test-mobile, test-database]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate Test Report
        run: |
          echo "# ğŸ§ª Pipeline Test Report" > test-report.md
          echo "" >> test-report.md
          echo "**Date:** $(date)" >> test-report.md
          echo "**Pipeline Tested:** ${{ github.event.inputs.pipeline }}" >> test-report.md
          echo "" >> test-report.md
          
          # Check job results
          echo "## Job Results" >> test-report.md
          echo "" >> test-report.md
          
          if [ "${{ needs.test-backend.result }}" = "success" ]; then
            echo "- âœ… Backend Pipeline: PASSED" >> test-report.md
          elif [ "${{ needs.test-backend.result }}" = "skipped" ]; then
            echo "- â­ï¸ Backend Pipeline: SKIPPED" >> test-report.md
          else
            echo "- âŒ Backend Pipeline: FAILED" >> test-report.md
          fi
          
          if [ "${{ needs.test-frontend.result }}" = "success" ]; then
            echo "- âœ… Frontend Pipeline: PASSED" >> test-report.md
          elif [ "${{ needs.test-frontend.result }}" = "skipped" ]; then
            echo "- â­ï¸ Frontend Pipeline: SKIPPED" >> test-report.md
          else
            echo "- âŒ Frontend Pipeline: FAILED" >> test-report.md
          fi
          
          if [ "${{ needs.test-mobile.result }}" = "success" ]; then
            echo "- âœ… Mobile Pipeline: PASSED" >> test-report.md
          elif [ "${{ needs.test-mobile.result }}" = "skipped" ]; then
            echo "- â­ï¸ Mobile Pipeline: SKIPPED" >> test-report.md
          else
            echo "- âŒ Mobile Pipeline: FAILED" >> test-report.md
          fi
          
          if [ "${{ needs.test-database.result }}" = "success" ]; then
            echo "- âœ… Database Pipeline: PASSED" >> test-report.md
          elif [ "${{ needs.test-database.result }}" = "skipped" ]; then
            echo "- â­ï¸ Database Pipeline: SKIPPED" >> test-report.md
          else
            echo "- âŒ Database Pipeline: FAILED" >> test-report.md
          fi
          
          echo "" >> test-report.md
          echo "## Summary" >> test-report.md
          echo "Pipeline testing completed for: ${{ github.event.inputs.pipeline }}" >> test-report.md
          
          cat test-report.md

      - name: ğŸ“¤ Upload Test Report
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-test-report
          path: test-report.md