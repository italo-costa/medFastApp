<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè• MediApp - Gest√£o M√©dicos Modernizada</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            color: #2d3748;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #3182ce;
            color: white;
        }

        .btn-primary:hover {
            background: #2c5aa0;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-success {
            background: #38a169;
            color: white;
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .form-control {
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-content {
            background: white;
            border-radius: 0.75rem;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .pagination-info {
            color: #666;
            font-size: 0.875rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-ativo {
            background: #d1fae5;
            color: #065f46;
        }

        .status-inativo {
            background: #fee2e2;
            color: #991b1b;
        }

        .actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .filters {
                flex-direction: column;
            }

            .card-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-user-md"></i> Gest√£o de M√©dicos - Vers√£o Modernizada</h1>
            <p>Arquitetura aprimorada com Service Layer e State Management</p>
        </div>
    </div>

    <div class="container">
        <!-- Filtros -->
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-filter"></i> Filtros</h2>
                <button class="btn btn-primary" onclick="showMedicoModal()">
                    <i class="fas fa-plus"></i> Novo M√©dico
                </button>
            </div>
            <div style="padding: 1.5rem;">
                <div class="filters">
                    <input type="text" id="searchInput" class="form-control" placeholder="Buscar por nome ou CRM..." style="flex: 1; min-width: 200px;">
                    <select id="especialidadeFilter" class="form-control">
                        <option value="">Todas as especialidades</option>
                        <option value="Cardiologia">Cardiologia</option>
                        <option value="Pediatria">Pediatria</option>
                        <option value="Neurologia">Neurologia</option>
                        <option value="Ortopedia">Ortopedia</option>
                        <option value="Ginecologia">Ginecologia</option>
                    </select>
                    <button class="btn btn-secondary" onclick="clearFilters()">
                        <i class="fas fa-times"></i> Limpar
                    </button>
                    <button class="btn btn-primary" onclick="loadMedicos()">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                </div>
            </div>
        </div>

        <!-- Lista de M√©dicos -->
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-list"></i> Lista de M√©dicos</h2>
                <div id="recordCount" class="pagination-info"></div>
            </div>
            <div id="medicosContainer" style="padding: 1.5rem;">
                <!-- Os dados ser√£o carregados aqui via JavaScript -->
            </div>
            <div id="paginationContainer" class="pagination">
                <!-- Pagina√ß√£o ser√° inserida aqui -->
            </div>
        </div>
    </div>

    <!-- Modal para Cadastro/Edi√ß√£o -->
    <div id="medicoModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3 id="modalTitle"><i class="fas fa-user-md"></i> Novo M√©dico</h3>
            <form id="medicoForm">
                <div class="form-group">
                    <label for="nomeCompleto">Nome Completo *</label>
                    <input type="text" id="nomeCompleto" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="crm">CRM *</label>
                    <input type="text" id="crm" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="especialidade">Especialidade *</label>
                    <select id="especialidade" class="form-control" required>
                        <option value="">Selecione...</option>
                        <option value="Cardiologia">Cardiologia</option>
                        <option value="Pediatria">Pediatria</option>
                        <option value="Neurologia">Neurologia</option>
                        <option value="Ortopedia">Ortopedia</option>
                        <option value="Ginecologia">Ginecologia</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="telefone">Telefone</label>
                    <input type="tel" id="telefone" class="form-control">
                </div>
                <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" id="email" class="form-control" required>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeMedicoModal()" style="flex: 1;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/mediapp-service-layer.js"></script>
    <script>
        /**
         * üöÄ IMPLEMENTATION - Exemplo pr√°tico da nova arquitetura
         */

        // Global state
        let currentPage = 1;
        let currentFilters = {};
        let editingMedicoId = null;

        /**
         * üîÑ Initialize page
         */
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üè• Inicializando p√°gina de gest√£o de m√©dicos...');
            
            setupEventListeners();
            await loadMedicos();
        });

        /**
         * üéß Setup event listeners
         */
        function setupEventListeners() {
            // Search input with debounce
            let searchTimeout;
            document.getElementById('searchInput').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentFilters.search = e.target.value;
                    currentPage = 1;
                    loadMedicos();
                }, 500);
            });

            // Specialty filter
            document.getElementById('especialidadeFilter').addEventListener('change', (e) => {
                currentFilters.especialidade = e.target.value;
                currentPage = 1;
                loadMedicos();
            });

            // Form submission
            document.getElementById('medicoForm').addEventListener('submit', handleFormSubmit);

            // UI State subscribers
            window.uiState.subscribe('loading:/medicos', updateLoadingState);
            window.uiState.subscribe('error:/medicos', handleApiError);
        }

        /**
         * üìã Load medicos with current filters
         */
        async function loadMedicos() {
            try {
                const filters = {
                    ...currentFilters,
                    page: currentPage,
                    limit: 10
                };

                console.log('üîç Loading medicos with filters:', filters);
                const response = await window.medicoService.getAll(filters);

                if (response.success) {
                    renderMedicosTable(response.data);
                    renderPagination(response);
                    updateRecordCount(response);
                } else {
                    throw new Error(response.message || 'Erro ao carregar m√©dicos');
                }
            } catch (error) {
                console.error('‚ùå Error loading medicos:', error);
                renderError(error);
            }
        }

        /**
         * üé® Render medicos table
         */
        function renderMedicosTable(medicos) {
            const columns = [
                { field: 'nomeCompleto', label: 'Nome' },
                { field: 'crm', label: 'CRM' },
                { field: 'especialidade', label: 'Especialidade' },
                { 
                    field: 'status', 
                    label: 'Status', 
                    formatter: (value) => `<span class="status-badge status-${value.toLowerCase()}">${value}</span>`
                },
                { 
                    field: 'consultas', 
                    label: 'Consultas',
                    formatter: (value) => value || 0
                },
                {
                    field: 'id',
                    label: 'A√ß√µes',
                    formatter: (value, row) => `
                        <div class="actions">
                            <button class="btn btn-sm btn-primary" onclick="viewMedico('${value}')" title="Visualizar">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="editMedico('${value}')" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteMedico('${value}', '${row.nomeCompleto}')" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `
                }
            ];

            const isLoading = window.uiState.getState('loading:/medicos');
            const error = window.uiState.getState('error:/medicos');

            const tableHTML = UIComponents.createDataTable(medicos, columns, {
                isLoading,
                error
            });

            document.getElementById('medicosContainer').innerHTML = tableHTML;
        }

        /**
         * üìÑ Render pagination
         */
        function renderPagination(response) {
            const { page, totalPages, total } = response;
            
            if (totalPages <= 1) {
                document.getElementById('paginationContainer').innerHTML = '';
                return;
            }

            let paginationHTML = '';

            // Previous button
            if (page > 1) {
                paginationHTML += `<button class="btn btn-sm btn-secondary" onclick="goToPage(${page - 1})">Anterior</button>`;
            }

            // Page numbers
            for (let i = Math.max(1, page - 2); i <= Math.min(totalPages, page + 2); i++) {
                const isActive = i === page ? 'btn-primary' : 'btn-secondary';
                paginationHTML += `<button class="btn btn-sm ${isActive}" onclick="goToPage(${i})">${i}</button>`;
            }

            // Next button
            if (page < totalPages) {
                paginationHTML += `<button class="btn btn-sm btn-secondary" onclick="goToPage(${page + 1})">Pr√≥ximo</button>`;
            }

            document.getElementById('paginationContainer').innerHTML = paginationHTML;
        }

        /**
         * üìä Update record count
         */
        function updateRecordCount(response) {
            const { total, page, limit } = response;
            const start = (page - 1) * limit + 1;
            const end = Math.min(page * limit, total);
            
            document.getElementById('recordCount').textContent = 
                `Mostrando ${start}-${end} de ${total} registros`;
        }

        /**
         * üìÑ Pagination navigation
         */
        function goToPage(page) {
            currentPage = page;
            loadMedicos();
        }

        /**
         * üßπ Clear filters
         */
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('especialidadeFilter').value = '';
            currentFilters = {};
            currentPage = 1;
            loadMedicos();
        }

        /**
         * üëÅÔ∏è View medico details
         */
        async function viewMedico(id) {
            try {
                const response = await window.medicoService.getById(id);
                if (response.success) {
                    alert(`Detalhes do m√©dico:\n\nNome: ${response.data.nomeCompleto}\nCRM: ${response.data.crm}\nEspecialidade: ${response.data.especialidade}`);
                }
            } catch (error) {
                console.error('Error viewing medico:', error);
            }
        }

        /**
         * ‚úèÔ∏è Edit medico
         */
        async function editMedico(id) {
            try {
                const response = await window.medicoService.getById(id);
                if (response.success) {
                    const medico = response.data;
                    
                    // Fill form
                    document.getElementById('nomeCompleto').value = medico.nomeCompleto;
                    document.getElementById('crm').value = medico.crm;
                    document.getElementById('especialidade').value = medico.especialidade;
                    document.getElementById('telefone').value = medico.telefone || '';
                    document.getElementById('email').value = medico.email;
                    
                    // Set editing mode
                    editingMedicoId = id;
                    document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit"></i> Editar M√©dico';
                    
                    // Show modal
                    document.getElementById('medicoModal').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error editing medico:', error);
            }
        }

        /**
         * üóëÔ∏è Delete medico
         */
        async function deleteMedico(id, nome) {
            if (!confirm(`Tem certeza que deseja excluir o m√©dico "${nome}"?`)) {
                return;
            }

            try {
                const response = await window.medicoService.delete(id);
                if (response.success) {
                    await loadMedicos(); // Reload list
                    alert('M√©dico exclu√≠do com sucesso!');
                }
            } catch (error) {
                console.error('Error deleting medico:', error);
            }
        }

        /**
         * üìù Show modal for new medico
         */
        function showMedicoModal() {
            // Reset form
            document.getElementById('medicoForm').reset();
            editingMedicoId = null;
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-plus"></i> Novo M√©dico';
            
            // Show modal
            document.getElementById('medicoModal').style.display = 'flex';
        }

        /**
         * ‚ùå Close modal
         */
        function closeMedicoModal() {
            document.getElementById('medicoModal').style.display = 'none';
            editingMedicoId = null;
        }

        /**
         * üíæ Handle form submission
         */
        async function handleFormSubmit(event) {
            event.preventDefault();
            
            const formData = {
                nomeCompleto: document.getElementById('nomeCompleto').value,
                crm: document.getElementById('crm').value,
                especialidade: document.getElementById('especialidade').value,
                telefone: document.getElementById('telefone').value,
                email: document.getElementById('email').value
            };

            try {
                let response;
                if (editingMedicoId) {
                    response = await window.medicoService.update(editingMedicoId, formData);
                } else {
                    response = await window.medicoService.create(formData);
                }

                if (response.success) {
                    closeMedicoModal();
                    await loadMedicos();
                    alert(editingMedicoId ? 'M√©dico atualizado com sucesso!' : 'M√©dico cadastrado com sucesso!');
                }
            } catch (error) {
                console.error('Error saving medico:', error);
            }
        }

        /**
         * üîÑ Handle loading state changes
         */
        function updateLoadingState(isLoading) {
            if (isLoading) {
                document.getElementById('medicosContainer').innerHTML = UIComponents.createLoadingSpinner('Carregando m√©dicos...');
            }
        }

        /**
         * ‚ùå Handle API errors
         */
        function handleApiError(error) {
            console.error('API Error:', error);
        }

        /**
         * ‚ùå Render error state
         */
        function renderError(error) {
            document.getElementById('medicosContainer').innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Erro ao carregar dados</h3>
                    <p>${error.message}</p>
                    <button onclick="loadMedicos()" class="btn btn-primary">
                        <i class="fas fa-redo"></i> Tentar Novamente
                    </button>
                </div>
            `;
        }

        // Close modal when clicking outside
        document.getElementById('medicoModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                closeMedicoModal();
            }
        });

    </script>
</body>
</html>