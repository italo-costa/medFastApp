<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Analytics Dashboard - MediApp</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .nav-buttons {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .nav-btn.secondary {
            background: #f8f9fa;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .nav-btn.secondary:hover {
            background: #667eea;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-number.total { color: #667eea; }
        .stat-number.ativos { color: #28a745; }
        .stat-number.pacientes { color: #ffc107; }
        .stat-number.consultas { color: #6f42c1; }

        .stat-label {
            color: #666;
            font-size: 1.1em;
        }

        .stat-trend {
            font-size: 0.9em;
            margin-top: 8px;
            padding: 4px 8px;
            border-radius: 12px;
            display: inline-block;
        }

        .stat-trend.up {
            background: #d4edda;
            color: #155724;
        }

        .stat-trend.down {
            background: #f8d7da;
            color: #721c24;
        }

        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .chart-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 15px;
        }

        .chart-container.large {
            height: 400px;
        }

        .activities-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .activities-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .activities-header h3 {
            color: #667eea;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.3s ease;
        }

        .activity-item:hover {
            background: #f8f9fa;
            border-radius: 8px;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1em;
        }

        .activity-icon.cadastro { background: #28a745; }
        .activity-icon.consulta { background: #667eea; }
        .activity-icon.exame { background: #ffc107; }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .activity-description {
            color: #666;
            font-size: 0.9em;
        }

        .activity-time {
            color: #999;
            font-size: 0.8em;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 40px;
            height: 40px;
            margin-left: 10px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }

        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .chart-container {
                height: 250px;
            }

            .nav-buttons {
                flex-direction: column;
                align-items: center;
            }
        }

        .refresh-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: #218838;
        }

        .no-data {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üìä Analytics Dashboard</h1>
            <p>Vis√£o completa dos dados do sistema MediApp com gr√°ficos e estat√≠sticas em tempo real</p>
            
            <div class="nav-buttons">
                <a href="/app.html" class="nav-btn secondary">
                    <i class="fas fa-arrow-left"></i>
                    Voltar ao Sistema
                </a>
                <a href="/analytics-mapas.html" class="nav-btn secondary">
                    <i class="fas fa-map"></i>
                    Mapas Geoespaciais
                </a>
                <button class="nav-btn" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt"></i>
                    Atualizar Dados
                </button>
            </div>
        </div>

        <!-- Estat√≠sticas Principais -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number total" id="totalMedicos">-</div>
                <div class="stat-label">Total de M√©dicos</div>
                <div class="stat-trend up" id="trendMedicos">+0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-number ativos" id="medicosAtivos">-</div>
                <div class="stat-label">M√©dicos Ativos</div>
                <div class="stat-trend up" id="percentualAtivos">0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-number pacientes" id="totalPacientes">-</div>
                <div class="stat-label">Pacientes Cadastrados</div>
                <div class="stat-trend up" id="trendPacientes">+0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-number consultas" id="totalConsultas">-</div>
                <div class="stat-label">Consultas Realizadas</div>
                <div class="stat-trend up" id="trendConsultas">+0%</div>
            </div>
        </div>

        <!-- Gr√°ficos -->
        <div class="charts-section">
            <!-- Especialidades -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="fas fa-user-md"></i>
                        M√©dicos por Especialidade
                    </h3>
                    <button class="refresh-btn" onclick="refreshChart('especialidades')">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="chart-container">
                    <canvas id="chartEspecialidades"></canvas>
                </div>
            </div>

            <!-- Estados -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="fas fa-map-marker-alt"></i>
                        M√©dicos por Estado
                    </h3>
                    <button class="refresh-btn" onclick="refreshChart('estados')">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="chart-container">
                    <canvas id="chartEstados"></canvas>
                </div>
            </div>

            <!-- Cadastros Mensais -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="fas fa-chart-line"></i>
                        Cadastros por M√™s
                    </h3>
                    <button class="refresh-btn" onclick="refreshChart('cadastros')">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="chart-container">
                    <canvas id="chartCadastros"></canvas>
                </div>
            </div>

            <!-- Distribui√ß√£o de Idade -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">
                        <i class="fas fa-users"></i>
                        Distribui√ß√£o por Idade
                    </h3>
                    <button class="refresh-btn" onclick="refreshChart('idade')">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="chart-container">
                    <canvas id="chartIdade"></canvas>
                </div>
            </div>
        </div>

        <!-- Atividades Recentes -->
        <div class="activities-section">
            <div class="activities-header">
                <h3>
                    <i class="fas fa-history"></i>
                    Atividades Recentes
                </h3>
                <button class="refresh-btn" onclick="refreshActivities()">
                    <i class="fas fa-sync-alt"></i>
                    Atualizar
                </button>
            </div>
            <div id="activitiesContainer">
                <div class="loading">Carregando atividades...</div>
            </div>
        </div>
    </div>

    <script>
        // Vari√°veis globais para armazenar os gr√°ficos
        let charts = {};
        let dashboardData = null;

        // Configura√ß√µes padr√£o para gr√°ficos
        Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
        Chart.defaults.color = '#666';

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
        });

        // Carregar dados do dashboard
        async function loadDashboardData() {
            try {
                showMessage('Carregando dados do dashboard...', 'info');
                
                const response = await fetch('/api/dashboard');
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    dashboardData = data.data;
                    updateStatistics(dashboardData.metricas);
                    createCharts(dashboardData.graficos);
                    updateActivities(dashboardData.atividadesRecentes);
                    showMessage('Dashboard carregado com sucesso!', 'success');
                } else {
                    throw new Error(data.message || 'Erro ao carregar dashboard');
                }
                
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
                showMessage(`Erro ao carregar dashboard: ${error.message}`, 'error');
                loadMockData(); // Fallback para dados mock
            }
        }

        // Atualizar estat√≠sticas
        function updateStatistics(metricas) {
            document.getElementById('totalMedicos').textContent = metricas.totalMedicos || 0;
            document.getElementById('medicosAtivos').textContent = metricas.medicosAtivos || 0;
            document.getElementById('percentualAtivos').textContent = `${metricas.percentualAtivos || 0}% ativos`;
            
            // Buscar dados de pacientes e consultas
            loadAdditionalStats();
            
            // Atualizar trend
            const trendElement = document.getElementById('trendMedicos');
            if (metricas.taxaCrescimento !== undefined) {
                trendElement.textContent = `${metricas.taxaCrescimento > 0 ? '+' : ''}${metricas.taxaCrescimento}%`;
                trendElement.className = `stat-trend ${metricas.taxaCrescimento >= 0 ? 'up' : 'down'}`;
            }
        }

        // Carregar estat√≠sticas adicionais
        async function loadAdditionalStats() {
            try {
                // Carregar pacientes
                const patientsResponse = await fetch('/api/patients');
                if (patientsResponse.ok) {
                    const patientsData = await patientsResponse.json();
                    const totalPacientes = Array.isArray(patientsData) ? patientsData.length : 
                                         (patientsData.data ? patientsData.data.length : 0);
                    document.getElementById('totalPacientes').textContent = totalPacientes;
                }

                // Carregar consultas (se existir endpoint)
                try {
                    const consultasResponse = await fetch('/api/consultas');
                    if (consultasResponse.ok) {
                        const consultasData = await consultasResponse.json();
                        const totalConsultas = Array.isArray(consultasData) ? consultasData.length : 
                                             (consultasData.data ? consultasData.data.length : 0);
                        document.getElementById('totalConsultas').textContent = totalConsultas;
                    }
                } catch (e) {
                    // Endpoint de consultas pode n√£o existir ainda
                    document.getElementById('totalConsultas').textContent = '0';
                }
                
            } catch (error) {
                console.error('Erro ao carregar estat√≠sticas adicionais:', error);
            }
        }

        // Criar gr√°ficos
        function createCharts(graficos) {
            // Destruir gr√°ficos existentes
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};

            // Gr√°fico de Especialidades
            if (graficos.especialidades) {
                createChart('chartEspecialidades', graficos.especialidades);
            }

            // Gr√°fico de Estados
            if (graficos.estados) {
                createChart('chartEstados', graficos.estados);
            }

            // Gr√°fico de Cadastros Mensais
            if (graficos.cadastrosMensais) {
                createChart('chartCadastros', graficos.cadastrosMensais);
            }

            // Gr√°fico de Distribui√ß√£o de Idade
            if (graficos.idadeDistribuicao) {
                createChart('chartIdade', graficos.idadeDistribuicao);
            }
        }

        // Criar gr√°fico individual
        function createChart(canvasId, dadosGrafico) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            const config = {
                type: dadosGrafico.tipo,
                data: {
                    labels: dadosGrafico.labels,
                    datasets: [{
                        label: dadosGrafico.titulo,
                        data: dadosGrafico.dados,
                        backgroundColor: dadosGrafico.cores,
                        borderColor: dadosGrafico.cores,
                        borderWidth: dadosGrafico.tipo === 'line' ? 3 : 1,
                        fill: dadosGrafico.tipo === 'line' ? false : true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: dadosGrafico.tipo !== 'bar',
                            position: 'bottom'
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderColor: '#667eea',
                            borderWidth: 1
                        }
                    },
                    scales: dadosGrafico.tipo === 'bar' || dadosGrafico.tipo === 'line' ? {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    } : {}
                }
            };

            charts[canvasId] = new Chart(ctx, config);
        }

        // Atualizar atividades
        function updateActivities(atividades) {
            const container = document.getElementById('activitiesContainer');
            
            if (!atividades || atividades.length === 0) {
                container.innerHTML = '<div class="no-data">Nenhuma atividade recente encontrada</div>';
                return;
            }

            container.innerHTML = atividades.map(atividade => `
                <div class="activity-item">
                    <div class="activity-icon ${atividade.tipo}">
                        <i class="fas fa-${atividade.icon || 'user-plus'}"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">${atividade.titulo}</div>
                        <div class="activity-description">${atividade.descricao}</div>
                        <div class="activity-time">${formatDate(atividade.data)}</div>
                    </div>
                </div>
            `).join('');
        }

        // Carregar dados mock como fallback
        function loadMockData() {
            const mockData = {
                metricas: {
                    totalMedicos: 25,
                    medicosAtivos: 23,
                    percentualAtivos: 92,
                    taxaCrescimento: 15.2
                },
                graficos: {
                    especialidades: {
                        titulo: 'M√©dicos por Especialidade',
                        tipo: 'doughnut',
                        labels: ['Cardiologia', 'Pediatria', 'Dermatologia', 'Ortopedia', 'Neurologia'],
                        dados: [8, 6, 4, 4, 3],
                        cores: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6']
                    },
                    estados: {
                        titulo: 'M√©dicos por Estado',
                        tipo: 'bar',
                        labels: ['SP', 'RJ', 'MG', 'RS', 'PR'],
                        dados: [12, 8, 3, 1, 1],
                        cores: ['#3B82F6']
                    }
                },
                atividadesRecentes: [
                    {
                        tipo: 'cadastro',
                        titulo: 'Novo m√©dico cadastrado',
                        descricao: 'Dr. Jo√£o Silva - Cardiologia',
                        data: new Date().toISOString(),
                        icon: 'user-plus'
                    }
                ]
            };

            updateStatistics(mockData.metricas);
            createCharts(mockData.graficos);
            updateActivities(mockData.atividadesRecentes);
            
            // Definir valores mock para estat√≠sticas adicionais
            document.getElementById('totalPacientes').textContent = '150';
            document.getElementById('totalConsultas').textContent = '320';
        }

        // Fun√ß√µes auxiliares
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Hoje';
            if (diffDays === 1) return 'Ontem';
            if (diffDays < 7) return `${diffDays} dias atr√°s`;
            
            return date.toLocaleDateString('pt-BR');
        }

        function showMessage(message, type) {
            // Remove mensagens existentes
            const existingMessages = document.querySelectorAll('.success-message, .error-message');
            existingMessages.forEach(msg => msg.remove());
            
            if (type === 'info') return; // N√£o mostrar mensagens de info
            
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;
            
            document.querySelector('.container').insertBefore(messageDiv, document.querySelector('.stats-grid'));
            
            // Remove a mensagem ap√≥s 5 segundos
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Fun√ß√µes de refresh
        function refreshDashboard() {
            loadDashboardData();
        }

        function refreshChart(tipo) {
            if (dashboardData && dashboardData.graficos) {
                // Recriar gr√°fico espec√≠fico
                const grafico = dashboardData.graficos[tipo === 'especialidades' ? 'especialidades' :
                                                    tipo === 'estados' ? 'estados' :
                                                    tipo === 'cadastros' ? 'cadastrosMensais' :
                                                    tipo === 'idade' ? 'idadeDistribuicao' : null];
                
                if (grafico) {
                    const canvasId = tipo === 'especialidades' ? 'chartEspecialidades' :
                                   tipo === 'estados' ? 'chartEstados' :
                                   tipo === 'cadastros' ? 'chartCadastros' :
                                   tipo === 'idade' ? 'chartIdade' : null;
                    
                    if (canvasId && charts[canvasId]) {
                        charts[canvasId].destroy();
                        createChart(canvasId, grafico);
                    }
                }
            }
        }

        function refreshActivities() {
            if (dashboardData && dashboardData.atividadesRecentes) {
                updateActivities(dashboardData.atividadesRecentes);
            }
        }
    </script>
</body>
</html>